# 🌌 藏在声音里的图片

### 向旅行者金唱片的现代致敬

> **「把人类的图像，刻进声波之中。」**

本项目灵感来自旅行者1号（Voyager 1）携带的旅行者金唱片（Voyager Golden Record）——
那张于1977年飞向星际空间的镀金铜盘，以**模拟音频**形式保存地球的声音、音乐与图像，期待某日被宇宙中的智慧生命解读。

本项目以数字方式重现这个浪漫构想：

* 将一张灰度图片编码为一段 **FLAC 无损音频**
* 将部分需要传递的参数写入 **FLAC 元数据（metadata）**
* 解码时同步播放音频，并即时重建画面
* 同时输出原始分辨率图片

这不是隐写术，而是一种跨模态转译：

> **视觉 ↔ 听觉**

当声波流动时，画面也在屏幕上缓缓浮现——
仿佛某个文明正在「聆听」并重建我们的世界。

---

# 🔬 核心原理

### 🎼 像素 → 频率

每个灰度像素（0~255）对应一段纯正弦波：

| 灰度 | 对应频率 |
|------|----------|
| 黑 (0) | 500 Hz |
| 白 (255) | 3000 Hz |

计算公式：

```
freq = F_MIN + (像素灰度值/255) * (F_MAX - F_MIN)
```

---

### 🧠 编码流程

1. 读取图片并转为灰度模式（0=黑，255=白）
2. 按**列优先**顺序展开像素（先遍历第一列所有像素，再第二列，以此类推）
3. 每个像素生成固定长度的正弦波（采样点数由 `SAMPLES_PER_PIXEL` 定义）
4. 串联所有正弦波为单声道音频信号
5. 对音频信号限幅（确保值在[-1, 1]范围内），避免失真
6. 以 **FLAC 格式写入** 音频文件
7. 将图像参数写入 FLAC 元数据（JSON 格式）

---

### 🔎 解码流程

1. 读取 FLAC 音频文件及元数据
2. 从元数据中解析图像分辨率、频率范围、采样率等关键参数
3. 初始化 pygame 音频播放和绘图窗口
4. 按编码时的列优先顺序，截取每个像素对应的音频段
5. 对音频段加汉宁窗（减少频谱泄漏）并补零后执行快速傅里叶变换（FFT）
6. 寻找目标频率范围内的幅值峰值，计算对应频率
7. 将检测到的频率映射回0-255的灰度值
8. 即时将像素绘制到 pygame 窗口（每处理1024个像素刷新一次显示）
9. 最终将还原的像素数组转换为图像并保存
10. 保持窗口显示直至用户主动关闭

解码时音频会**同步播放**，画面随声波逐步成形。

---

# 📦 安装依赖

建议使用 Python 3.11 版本

```bash
pip install -r requirements.txt
```

### 📚 套件说明

| 套件        | 用途                    |
| --------- | --------------------- |
| numpy     | 数值运算 / 快速傅里叶变换（FFT）/ 音频信号生成 |
| Pillow    | 图像读写与格式转换（灰度模式处理） |
| pygame    | 音频播放 + 即时绘图 + 窗口管理 |
| soundfile | FLAC 音频写入与读取（支持float32格式） |
| mutagen   | FLAC 元数据（metadata）写入 / 读取（JSON序列化） |

⚠️ 本项目使用 **FLAC 元数据** 存储图像参数，因此必须安装 `mutagen`。

---

# 🚀 使用方式

## 1️⃣ 编码：图片 → FLAC 声音

```bash
python app.py encode input.jpg signal.flac
```

输出：
* `signal.flac`（包含图像元数据的无损音频文件）

终端会显示：
* 加载图像
* 原始图像分辨率
* 生成的音频时长

---

## 2️⃣ 解码：播放 + 即时绘图

```bash
python app.py draw signal.flac recovered.png
```

功能：
* 自动播放音频（音量默认5%，避免音量过大）
* 1280×720固定分辨率窗口显示（自动缩放图片以完整显示）
* 逐像素即时绘制还原图像
* 最终输出 `recovered.png`（原始分辨率灰度图像）

若音频较长，图片绘制完成后音频可能仍会播放，关闭窗口即可结束程序。

---

# 🖥 窗口显示机制

* pygame 窗口固定分辨率：1280×720（由 `SCREEN_W`/`SCREEN_H` 定义）
* 图片会按比例自动缩放（保持原始长宽比）
* 缩放规则：取宽度和高度缩放比例的最小值，确保图像完整显示且不拉伸变形
* 图像在窗口中居中显示
* 使用 `pygame.transform.smoothscale` 实现平滑缩放，提升显示效果

---

# ⚙️ 可调节参数（位于 app.py 顶部）

| 参数                | 默认值   | 说明                 |
| ----------------- | ----- | ------------------ |
| F_MIN             | 500   | 音频频率最小值（对应图像黑色） |
| F_MAX             | 3000  | 音频频率最大值（对应图像白色） |
| SAMPLE_RATE       | 44100 | 音频采样率 |
| SAMPLES_PER_PIXEL | 128   | 每个像素点对应的音频采样点数（越大音频越长，频率检测越稳定） |
| SCREEN_W          | 1280  | 解码显示窗口宽度（像素） |
| SCREEN_H          | 720   | 解码显示窗口高度（像素） |
| N_FFT             | 512   | FFT变换点数（影响频率解析精度） |
| VOLUME_PERCENT    | 5     | 播放音量百分比（0-100） |

---

# 🎞 扫描风格

本项目固定采用**列优先**扫描模式：
- 编码时按列遍历像素（先第一列所有行，再第二列，依此类推）
- 解码时按相同顺序还原像素
- 画面由左至右展开，如卷轴般显现

---

# 💾 FLAC 元数据结构

存储在 FLAC 文件的 `IMAGE_METADATA` 字段中，内容为 JSON 格式：

```json
{
  "width": 1920,
  "height": 1080,
  "F_MIN": 500,
  "F_MAX": 3000,
  "SAMPLES_PER_PIXEL": 128,
  "SAMPLE_RATE": 44100,
  "N_FFT": 512
}
```

元数据包含解码所需的全部关键参数，因此解码时无需额外配置文件。

---

# ⚠️ 注意事项

1. 音频包含500–3000 Hz的中高频信号，默认音量已设为5%，建议先降低音箱/耳机音量。
2. 建议使用高对比度图片（剪影、文字、素描），复杂渐变图像可能因FFT分辨率产生轻微误差。
3. 解码时对音频段加汉宁窗并补零至N_FFT长度，可有效减少频谱泄漏，提升频率检测精度。
4. 频率检测时设置±100Hz容错范围，避免因频率偏移导致解码错误。
5. 所有音频信号都会进行限幅处理（`np.clip(audio, -1, 1)`），防止音频失真。
6. 若Windows启用DPI缩放，pygame窗口实际尺寸可能受影响，但不影响图像还原精度。

---

# 🌠 致敬星际讯息

> “The spacecraft will be encountered and the record played only if there are advanced spacefaring civilizations in interstellar space.”
> —— Carl Sagan

或许我们永远收不到回信。
但至少可以让一张图片，
**以声音的形式，在寂静中再次诞生。**
